<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº¬é˜ªåè¦ªå­éŠåŠ©æ‰‹ V7 (å…¨åˆªé™¤æ”¯æ´ç‰ˆ)</title>
    <style>
        :root {
            --primary: #007aff;
            --bg: #f2f2f7;
            --card-bg: #ffffff;
            --text: #1c1c1e;
            --gray: #8e8e93;
            --accent: #34c759;
            --danger: #ff3b30;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; background: var(--bg); color: var(--text); padding-bottom: 40px;
        }

        .header {
            background: linear-gradient(135deg, #007aff, #5856d6);
            color: white; padding: 20px 15px; text-align: center; position: sticky; top: 0; z-index: 100;
        }

        .weather-info {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px; padding: 8px; margin-top: 10px;
            font-size: 0.85rem; display: inline-block; min-width: 150px;
        }

        .card { background: var(--card-bg); margin: 12px; padding: 18px; border-radius: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        h3 { margin-top: 0; color: var(--primary); font-size: 1.1rem; border-left: 4px solid var(--primary); padding-left: 10px; }

        .schedule-list { text-align: left; padding: 0; list-style: none; }
        .schedule-item {
            padding: 12px; border-radius: 12px; margin-bottom: 8px; background: #f8f8fa;
            display: flex; align-items: flex-start; gap: 10px; cursor: pointer; border: 2px solid transparent; 
            position: relative; transition: 0.2s;
        }
        .schedule-item.active { border-color: var(--primary); background: #f0f7ff; }
        /* æ¨™ç¤ºè‡ªè¨‚è¡Œç¨‹èˆ‡é è¨­è¡Œç¨‹çš„å€åˆ¥ */
        .schedule-item.custom { border-left: 4px solid var(--accent); }
        
        .schedule-time { font-size: 0.75rem; color: var(--primary); font-weight: bold; min-width: 45px; margin-top: 3px; }
        .schedule-text { font-size: 0.95rem; font-weight: 600; flex: 1; padding-right: 25px; }
        .schedule-sub { font-size: 0.8rem; color: var(--gray); margin-top: 2px; font-weight: normal; }

        .del-item {
            position: absolute; right: 8px; top: 12px; color: var(--danger);
            font-size: 1.1rem; padding: 5px; cursor: pointer; z-index: 10; opacity: 0.6;
        }
        .del-item:hover { opacity: 1; }

        .add-form { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        .add-form input { width: 100%; margin-bottom: 8px; box-sizing: border-box; padding: 10px; border: 1px solid #ddd; border-radius: 10px;}
        
        .map-container { width: 100%; height: 230px; margin-bottom: 15px; }
        iframe { width: 100%; height: 100%; border: none; border-radius: 14px; background: #eee; }

        .nav-btns { display: flex; justify-content: space-between; margin-top: 15px; gap: 10px; }
        button { padding: 12px; border: none; border-radius: 12px; background: var(--primary); color: white; font-weight: 600; cursor: pointer; }
        button.secondary { background: #e5e5ea; color: var(--text); }
        button.action-link { background: none; color: var(--primary); font-size: 0.75rem; text-decoration: underline; margin-top: 10px; width: 100%; }

        .packing-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f9f9f9; cursor: pointer; }
        .checked { text-decoration: line-through; color: var(--gray); }
    </style>
</head>
<body>

<div class="header">
    <h2 id="dayDisplay" style="margin:0">Day 1</h2>
    <div id="dateDisplay" style="font-size:0.9rem; opacity:0.9">3æœˆ11æ—¥</div>
    <div id="weatherDisplay" class="weather-info">â³ å¤©æ°£è¼‰å…¥ä¸­...</div>
</div>

<div class="card">
    <div class="map-container">
        <iframe id="mapFrame"></iframe>
    </div>
    
    <ul id="scheduleList" class="schedule-list"></ul>
    
    <button class="secondary" style="width:100%; margin-top: 10px; font-size: 0.9rem;" onclick="toggleAddForm()">ç®¡ç†è¡Œç¨‹ (æ–°å¢/é‡ç½®)</button>
    
    <div id="addForm" class="add-form">
        <label style="font-size:0.75rem; color:var(--gray)">æ–°å¢è‡ªè¨‚æ™¯é»ï¼š</label>
        <input id="newTime" type="time" value="12:00">
        <input id="newTitle" placeholder="æ™¯é»æˆ–é¤å»³åç¨±">
        <button style="width:100%; background: var(--accent); margin-bottom:15px;" onclick="addCustomItem()">ç¢ºå®šæ–°å¢</button>
        
        <hr style="border:0; border-top:1px solid #eee">
        <button class="action-link" onclick="restoreDefaultSchedule()">æ¢å¾©ç•¶æ—¥åŸå§‹é è¨­è¡Œç¨‹</button>
    </div>

    <div class="nav-btns">
        <button class="secondary" onclick="changeDay(-1)">â† ä¸Šä¸€å¤©</button>
        <button onclick="changeDay(1)">ä¸‹ä¸€å¤© â†’</button>
    </div>
</div>

<div class="card">
    <h3>ğŸ§³ å¿…å‚™ç‰©è³‡ç¢ºèª</h3>
    <div id="packingList"></div>
</div>

<script>
// åŸå§‹å›ºå®šè¡Œç¨‹è³‡æ–™
const DEFAULT_SCHEDULE = [
    { date: "3æœˆ11æ—¥", city: "Osaka", lat: 34.69, lon: 135.50, items: [
        { id: "base1_1", time: "06:55", icon: "âœˆï¸", title: "è™èˆª IT284", sub: "é«˜é›„-é—œè¥¿ KIX", loc: "Kansai International Airport" },
        { id: "base1_2", time: "14:00", icon: "ğŸ¨", title: "å¤§é˜ªé¾ä»•æŸé£¯åº—", sub: "Hotel Hankyu RESPIRE", loc: "Hotel Hankyu RESPIRE OSAKA" },
        { id: "base1_3", time: "16:00", icon: "ğŸŒ…", title: "æ¢…ç”°ç©ºä¸­åº­åœ’", sub: "5æ­²å°å­©ä¹Ÿé©åˆçš„å¤œæ™¯", loc: "Umeda Sky Building" },
        { id: "base1_4", time: "17:30", icon: "ğŸ›ï¸", title: "å¤§ä¸¸ç™¾è²¨æ¢…ç”°åº—", sub: "13F å¯¶å¯å¤¢ä¸­å¿ƒ", loc: "Daimaru Umeda" }
    ]},
    { date: "3æœˆ12æ—¥", city: "Osaka", lat: 34.69, lon: 135.50, items: [
        { id: "base2_1", time: "10:00", icon: "ğŸ ", title: "æµ·éŠé¤¨", sub: "çœ‹é¯¨é¯Šã€è§¸æ‘¸æ± ", loc: "Osaka Kaiyukan Aquarium" },
        { id: "base2_2", time: "12:30", icon: "ğŸ±", title: "å¤©ä¿å±±è³¼ç‰©ä¸­å¿ƒ", sub: "åˆé¤æ¨è–¦ï¼šæµªèŠ±ç¾é£Ÿæ©«ä¸", loc: "Tempozan Marketplace" },
        { id: "base2_3", time: "17:00", icon: "ğŸ§¸", title: "Yodobashi 5F", sub: "å·¨å¤§ç©å…·å€èˆ‡æ‰­è›‹", loc: "Links Umeda" }
    ]},
    { date: "3æœˆ13æ—¥", city: "Nagoya", lat: 35.18, lon: 136.90, items: [{ id: "base3_1", time: "10:00", icon: "ğŸš„", title: "åå¤å±‹ç§»å‹•æ—¥", sub: "æ–°å¹¹ç·š", loc: "Nagoya Station" }]},
    { date: "3æœˆ14æ—¥", city: "Nagoya", lat: 35.18, lon: 136.90, items: [{ id: "base4_1", time: "10:00", icon: "ğŸŒ³", title: "å‰åœåŠ›å…¬åœ’", sub: "å®®å´é§¿ä¸–ç•Œ", loc: "Ghibli Park" }]},
    { date: "3æœˆ15æ—¥", city: "Nagoya", lat: 35.18, lon: 136.90, items: [{ id: "base5_1", time: "10:00", icon: "ğŸš‚", title: "ç£æµ®éµé“é¤¨", sub: "æ–°å¹¹ç·šå±•è¦½", loc: "SCMAGLEV and Railway Park" }]},
    { date: "3æœˆ16æ—¥", city: "Nagoya", lat: 35.18, lon: 136.90, items: [{ id: "base6_1", time: "09:30", icon: "ğŸ¤–", title: "æ¨‚é«˜æ¨‚åœ’", sub: "æœ€å¾Œè¡åˆº", loc: "LEGOLAND Japan" }]}
];

let currentDay = 1;
// å¾ç€è¦½å™¨è®€å–ã€Œç›®å‰è¡Œç¨‹ç‹€æ…‹ã€ï¼Œè‹¥æ²’æœ‰å‰‡åˆå§‹åŒ–ç‚ºåŸå§‹è¡Œç¨‹
let activeSchedule = JSON.parse(localStorage.getItem("activeSchedule")) || JSON.parse(JSON.stringify(DEFAULT_SCHEDULE));
let packingStatus = JSON.parse(localStorage.getItem("packingStatus")) || {};

window.onload = () => { initDay(); updateUI(); renderPacking(); };

function initDay() {
    const tripStart = new Date("2026-03-11T00:00:00");
    const diff = new Date() - tripStart;
    const day = Math.floor(diff / (1000 * 60 * 60 * 24)) + 1;
    currentDay = (day > 0 && day <= 6) ? day : 1;
}

async function fetchWeather(lat, lon, city) {
    const display = document.getElementById("weatherDisplay");
    try {
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=Asia%2FTokyo`);
        const data = await res.json();
        const temp = Math.round(data.current_weather.temperature);
        const code = data.current_weather.weathercode;
        const weatherMap = { 0: "â˜€ï¸ æ™´æœ—", 1: "ğŸŒ¤ï¸ æ™´å¤šé›²", 2: "â›… å¤šé›²", 3: "â˜ï¸ é™°å¤©", 61: "ğŸŒ§ï¸ å°é›¨", 63: "ğŸŒ§ï¸ é›¨" };
        display.innerHTML = `ğŸ“ ${city === 'Osaka' ? 'å¤§é˜ª' : 'åå¤å±‹'}ï¼š${temp}Â°C | ${weatherMap[code] || "ğŸŒ¤ï¸ è‰¯å¥½"}`;
    } catch (e) { display.innerHTML = "âŒ å¤©æ°£æ›´æ–°ä¸­"; }
}

function updateUI() {
    const dayData = activeSchedule[currentDay - 1];
    document.getElementById("dayDisplay").innerText = `ç¬¬ ${currentDay} å¤©`;
    document.getElementById("dateDisplay").innerText = dayData.date;
    fetchWeather(dayData.lat, dayData.lon, dayData.city);

    // æ’åºè¡Œç¨‹
    dayData.items.sort((a,b) => a.time.localeCompare(b.time));

    const listEl = document.getElementById("scheduleList");
    listEl.innerHTML = dayData.items.length === 0 ? 
        `<div style="text-align:center;color:#999;padding:20px;">ä»Šæ—¥æš«ç„¡è¡Œç¨‹</div>` :
        dayData.items.map((item) => `
            <li class="schedule-item ${item.isCustom ? 'custom' : ''}" onclick="setMap('${item.loc || item.title}', this)">
                <div class="schedule-time">${item.time}</div>
                <span class="schedule-icon">${item.icon || 'ğŸ“'}</span>
                <div class="schedule-text">
                    <div>${item.title}</div>
                    ${item.sub ? `<div class="schedule-sub">${item.sub}</div>` : ''}
                </div>
                <span class="del-item" onclick="deleteAnyItem('${item.id}', event)">âœ•</span>
            </li>
        `).join("");

    if (dayData.items.length > 0) setMap(dayData.items[0].loc || dayData.items[0].title);
}

// åˆªé™¤ä»»ä½•è¡Œç¨‹ (åŒ…å«é è¨­èˆ‡è‡ªè¨‚)
function deleteAnyItem(id, event) {
    event.stopPropagation();
    if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™é …è¡Œç¨‹å—ï¼Ÿ")) return;
    
    activeSchedule[currentDay - 1].items = activeSchedule[currentDay - 1].items.filter(item => item.id !== id);
    saveData();
    updateUI();
}

// æ¢å¾©ç•¶æ—¥åŸå§‹é è¨­è¡Œç¨‹
function restoreDefaultSchedule() {
    if(!confirm("é€™å°‡æœƒæ‰¾å›é€™ä¸€å¤©åŸæœ¬é è¨­çš„æ‰€æœ‰æ™¯é»ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
    activeSchedule[currentDay - 1].items = JSON.parse(JSON.stringify(DEFAULT_SCHEDULE[currentDay - 1].items));
    saveData();
    updateUI();
    toggleAddForm();
}

function addCustomItem() {
    const time = document.getElementById("newTime").value;
    const title = document.getElementById("newTitle").value;
    if(!title) return;

    activeSchedule[currentDay - 1].items.push({ 
        id: "custom_" + Date.now(), 
        time, 
        title, 
        isCustom: true,
        icon: "â­ï¸"
    });
    
    saveData();
    document.getElementById("newTitle").value = "";
    toggleAddForm();
    updateUI();
}

function saveData() {
    localStorage.setItem("activeSchedule", JSON.stringify(activeSchedule));
}

/* ===== å…¶ä»–åŸºç¤åŠŸèƒ½ ===== */
function setMap(location, element) {
    const searchUrl = `https://maps.google.com/maps?q=${encodeURIComponent(location)}&output=embed`;
    document.getElementById("mapFrame").src = searchUrl;
    if (element) {
        document.querySelectorAll('.schedule-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
    }
}

function changeDay(step) {
    const newDay = currentDay + step;
    if (newDay >= 1 && newDay <= 6) { currentDay = newDay; updateUI(); }
}

function toggleAddForm() {
    const form = document.getElementById("addForm");
    form.style.display = form.style.display === "block" ? "none" : "block";
}

function renderPacking() {
    const items = ["è­·ç…§/ç°½è­‰", "æ—¥å¹£ç¾é‡‘/å¡ç‰‡", "å°å­©å‚™ç”¨è—¥", "è¡Œå‹•é›»æº", "å°¿å¸ƒ/æ¿•ç´™å·¾", "é›¨å…·/å¤–å¥—"];
    document.getElementById("packingList").innerHTML = items.map(item => `
        <div class="packing-item ${packingStatus[item] ? 'checked' : ''}" onclick="toggleItem('${item}')">
            <input type="checkbox" ${packingStatus[item] ? 'checked' : ''}>
            <span style="margin-left:10px">${item}</span>
        </div>
    `).join("");
}

function toggleItem(item) {
    packingStatus[item] = !packingStatus[item];
    localStorage.setItem("packingStatus", JSON.stringify(packingStatus));
    renderPacking();
}
</script>

</body>
</html>